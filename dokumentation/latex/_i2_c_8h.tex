\hypertarget{_i2_c_8h}{}\section{sensor/sensor/\+I2C.h File Reference}
\label{_i2_c_8h}\index{sensor/sensor/\+I2\+C.\+h@{sensor/sensor/\+I2\+C.\+h}}


The code for the I2\+C-\/bus.  


{\ttfamily \#include $<$util/atomic.\+h$>$}\\*
{\ttfamily \#include $<$avr/io.\+h$>$}\\*
{\ttfamily \#include $<$avr/interrupt.\+h$>$}\\*
{\ttfamily \#include $<$util/delay.\+h$>$}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{_i2_c_8h_a43bafb28b29491ec7f871319b5a3b2f8}{F\+\_\+\+C\+PU}~16000000\+UL
\item 
\#define \hyperlink{_i2_c_8h_ae106ed126eff0ffa33378daacfbbcdb7}{I2\+Cstatus\+\_\+\+S\+T\+A\+RT}~0x08
\item 
\#define \hyperlink{_i2_c_8h_a86ef56020aa435f9af57015ee220c3e4}{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK}~0x18
\item 
\#define \hyperlink{_i2_c_8h_a28004b2b2ef10d3131ac4c4756da0ba0}{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}~0x20
\item 
\#define \hyperlink{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}~0x28
\item 
\#define \hyperlink{_i2_c_8h_a9de9a018a3f258d9e7a9ce44fb9e5cd1}{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}~0x30
\item 
\#define \hyperlink{_i2_c_8h_af046bfee1b2f1837e8a043ead63f8152}{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK}~0x40
\item 
\#define \hyperlink{_i2_c_8h_ae17f24111fe34b4aa114e90824b7865a}{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}~0x48
\item 
\#define \hyperlink{_i2_c_8h_aae56c6775054400d706c68b4701a1659}{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}~0x50
\item 
\#define \hyperlink{_i2_c_8h_a3678a376b6b796511e60d0eda8a89dbe}{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}~0x58
\item 
\#define \hyperlink{_i2_c_8h_a3df22e1e7b66be8b74b33ce077824292}{S\+L\+A\+\_\+W}~0x\+D0
\item 
\#define \hyperlink{_i2_c_8h_ae4af1f304be9d3202a445e7d6c235eaa}{S\+L\+A\+\_\+R}~0x\+D1
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{_i2_c_8h_a263c74ce484e3680c05a9118707fadb7}{I2\+C\+\_\+start} ()
\begin{DoxyCompactList}\small\item\em Opens up the I2\+C-\/bus. \end{DoxyCompactList}\item 
void \hyperlink{_i2_c_8h_af8dcc1bcb3e1c6c0fcdca4cf599a239b}{I2\+C\+\_\+stop} ()
\begin{DoxyCompactList}\small\item\em Shuts down the I2\+C-\/bus. \end{DoxyCompactList}\item 
int \hyperlink{_i2_c_8h_ad1a5ba420409525ff5ab1be86ac5e526}{error} ()
\begin{DoxyCompactList}\small\item\em An error function for the I2\+C-\/bus. \end{DoxyCompactList}\item 
int \hyperlink{_i2_c_8h_ac0f145afe8d662af199043939f4398d6}{i2c\+\_\+write} (unsigned char slave\+\_\+addr, unsigned char reg\+\_\+addr, unsigned char length, unsigned char const $\ast$data)
\begin{DoxyCompactList}\small\item\em Writes data to a register at slave. \end{DoxyCompactList}\item 
int \hyperlink{_i2_c_8h_ac2d47e7a6c76f93f9b537c31a2986e7b}{i2c\+\_\+read} (unsigned char slave\+\_\+addr, unsigned char reg\+\_\+addr, unsigned char length, unsigned char $\ast$data)
\begin{DoxyCompactList}\small\item\em Reads data from a register at slave. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
The code for the I2\+C-\/bus. 

\begin{DoxyVersion}{Version}
1.\+0 
\end{DoxyVersion}
\begin{DoxyAuthor}{Author}
Fredrik, Jonas 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
26 apr 2016 The code used by the sensor module to communicate with the I\+MU by the I2\+C-\/bus. 
\end{DoxyDate}


Definition in file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.



\subsection{Macro Definition Documentation}
\index{I2\+C.\+h@{I2\+C.\+h}!F\+\_\+\+C\+PU@{F\+\_\+\+C\+PU}}
\index{F\+\_\+\+C\+PU@{F\+\_\+\+C\+PU}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{F\+\_\+\+C\+PU}{F_CPU}}]{\setlength{\rightskip}{0pt plus 5cm}\#define F\+\_\+\+C\+PU~16000000\+UL}\hypertarget{_i2_c_8h_a43bafb28b29491ec7f871319b5a3b2f8}{}\label{_i2_c_8h_a43bafb28b29491ec7f871319b5a3b2f8}
Define the frequency for the C\+PU as 16 M\+Hz 

Definition at line \hyperlink{_i2_c_8h_source_l00020}{20} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}{I2Cstatus_MR_DATA_ACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK~0x50}\hypertarget{_i2_c_8h_aae56c6775054400d706c68b4701a1659}{}\label{_i2_c_8h_aae56c6775054400d706c68b4701a1659}
Master Receiver Mode recieving data A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00031}{31} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}{I2Cstatus_MR_DATA_NACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+R\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK~0x58}\hypertarget{_i2_c_8h_a3678a376b6b796511e60d0eda8a89dbe}{}\label{_i2_c_8h_a3678a376b6b796511e60d0eda8a89dbe}
Master Receiver Mode recieving data N\+A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00032}{32} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK}{I2Cstatus_MR_SLA_ACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+A\+CK~0x40}\hypertarget{_i2_c_8h_af046bfee1b2f1837e8a043ead63f8152}{}\label{_i2_c_8h_af046bfee1b2f1837e8a043ead63f8152}
Master Receiver Mode addressing the slave A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00029}{29} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}{I2Cstatus_MR_SLA_NACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+R\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK~0x48}\hypertarget{_i2_c_8h_ae17f24111fe34b4aa114e90824b7865a}{}\label{_i2_c_8h_ae17f24111fe34b4aa114e90824b7865a}
Master Receiver Mode addressing the slave N\+A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00030}{30} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK}{I2Cstatus_MT_DATA_ACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+A\+CK~0x28}\hypertarget{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}{}\label{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}
Master Transmitter Mode sending data A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00026}{26} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK}{I2Cstatus_MT_DATA_NACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+T\+\_\+\+D\+A\+T\+A\+\_\+\+N\+A\+CK~0x30}\hypertarget{_i2_c_8h_a9de9a018a3f258d9e7a9ce44fb9e5cd1}{}\label{_i2_c_8h_a9de9a018a3f258d9e7a9ce44fb9e5cd1}
Master Transmitter Mode sending data N\+A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00027}{27} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK}{I2Cstatus_MT_SLA_ACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+A\+CK~0x18}\hypertarget{_i2_c_8h_a86ef56020aa435f9af57015ee220c3e4}{}\label{_i2_c_8h_a86ef56020aa435f9af57015ee220c3e4}
Master Transmitter Mode addressing the slave A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00024}{24} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}}
\index{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK@{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK}{I2Cstatus_MT_SLA_NACK}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+M\+T\+\_\+\+S\+L\+A\+\_\+\+N\+A\+CK~0x20}\hypertarget{_i2_c_8h_a28004b2b2ef10d3131ac4c4756da0ba0}{}\label{_i2_c_8h_a28004b2b2ef10d3131ac4c4756da0ba0}
Master Transmitter Mode addressing the slave N\+A\+CK 

Definition at line \hyperlink{_i2_c_8h_source_l00025}{25} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!I2\+Cstatus\+\_\+\+S\+T\+A\+RT@{I2\+Cstatus\+\_\+\+S\+T\+A\+RT}}
\index{I2\+Cstatus\+\_\+\+S\+T\+A\+RT@{I2\+Cstatus\+\_\+\+S\+T\+A\+RT}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+Cstatus\+\_\+\+S\+T\+A\+RT}{I2Cstatus_START}}]{\setlength{\rightskip}{0pt plus 5cm}\#define I2\+Cstatus\+\_\+\+S\+T\+A\+RT~0x08}\hypertarget{_i2_c_8h_ae106ed126eff0ffa33378daacfbbcdb7}{}\label{_i2_c_8h_ae106ed126eff0ffa33378daacfbbcdb7}
Define the start state for the I2\+C-\/bus 

Definition at line \hyperlink{_i2_c_8h_source_l00022}{22} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!S\+L\+A\+\_\+R@{S\+L\+A\+\_\+R}}
\index{S\+L\+A\+\_\+R@{S\+L\+A\+\_\+R}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{S\+L\+A\+\_\+R}{SLA_R}}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+L\+A\+\_\+R~0x\+D1}\hypertarget{_i2_c_8h_ae4af1f304be9d3202a445e7d6c235eaa}{}\label{_i2_c_8h_ae4af1f304be9d3202a445e7d6c235eaa}
Slave address + read 

Definition at line \hyperlink{_i2_c_8h_source_l00035}{35} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.

\index{I2\+C.\+h@{I2\+C.\+h}!S\+L\+A\+\_\+W@{S\+L\+A\+\_\+W}}
\index{S\+L\+A\+\_\+W@{S\+L\+A\+\_\+W}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{S\+L\+A\+\_\+W}{SLA_W}}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+L\+A\+\_\+W~0x\+D0}\hypertarget{_i2_c_8h_a3df22e1e7b66be8b74b33ce077824292}{}\label{_i2_c_8h_a3df22e1e7b66be8b74b33ce077824292}
Slave address + write 

Definition at line \hyperlink{_i2_c_8h_source_l00034}{34} of file \hyperlink{_i2_c_8h_source}{I2\+C.\+h}.



\subsection{Function Documentation}
\index{I2\+C.\+h@{I2\+C.\+h}!error@{error}}
\index{error@{error}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{error()}{error()}}]{\setlength{\rightskip}{0pt plus 5cm}int error (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{_i2_c_8h_ad1a5ba420409525ff5ab1be86ac5e526}{}\label{_i2_c_8h_ad1a5ba420409525ff5ab1be86ac5e526}


An error function for the I2\+C-\/bus. 

An error function called if a problem is encountered during I2\+C-\/communication. 

Definition at line \hyperlink{_i2_c_8c_source_l00244}{244} of file \hyperlink{_i2_c_8c_source}{I2\+C.\+c}.


\begin{DoxyCode}
00245 \{
00246     \textcolor{keywordflow}{return} -1;
00247 \}
\end{DoxyCode}
\index{I2\+C.\+h@{I2\+C.\+h}!i2c\+\_\+read@{i2c\+\_\+read}}
\index{i2c\+\_\+read@{i2c\+\_\+read}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{i2c\+\_\+read(unsigned char slave\+\_\+addr, unsigned char reg\+\_\+addr, unsigned char length, unsigned char $\ast$data)}{i2c_read(unsigned char slave_addr, unsigned char reg_addr, unsigned char length, unsigned char *data)}}]{\setlength{\rightskip}{0pt plus 5cm}int i2c\+\_\+read (
\begin{DoxyParamCaption}
\item[{unsigned char}]{slave\+\_\+addr, }
\item[{unsigned char}]{reg\+\_\+addr, }
\item[{unsigned char}]{length, }
\item[{unsigned char $\ast$}]{data}
\end{DoxyParamCaption}
)}\hypertarget{_i2_c_8h_ac2d47e7a6c76f93f9b537c31a2986e7b}{}\label{_i2_c_8h_ac2d47e7a6c76f93f9b537c31a2986e7b}


Reads data from a register at slave. 

Reads some data from a register at the slave address. \begin{DoxySeeAlso}{See also}
I2\+C-\/start 
\end{DoxySeeAlso}

\begin{DoxyParams}{Parameters}
{\em slave\+\_\+addr} & The address of the slave \\
\hline
{\em reg\+\_\+addr} & The register address of the register to be read from at the slave \\
\hline
{\em length} & The length of the transmission \\
\hline
{\em data} & The data received \\
\hline
\end{DoxyParams}


Definition at line \hyperlink{_i2_c_8c_source_l00116}{116} of file \hyperlink{_i2_c_8c_source}{I2\+C.\+c}.


\begin{DoxyCode}
00118 \{
00119     int8\_t timer = 0;
00120 
00121     \hyperlink{_i2_c_8c_a263c74ce484e3680c05a9118707fadb7}{I2C\_start}();
00122 
00123     \textcolor{comment}{// Ladda in IMU:ns adress + indikera att skrivning ska ske}
00124     TWDR = \hyperlink{_i2_c_8h_a3df22e1e7b66be8b74b33ce077824292}{SLA\_W};                                  
00125     TWCR = (1<<TWINT) | (1<<TWEN);      \textcolor{comment}{// Skicka}
00126 
00127     \textcolor{comment}{// Vänta på att det har skickats}
00128     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00129     \{
00130         \_delay\_ms(1);
00131         ++timer;
00132         \textcolor{keywordflow}{if} (timer >= 20)
00133         \{
00134             \textcolor{keywordflow}{return} -1;
00135         \}
00136     \}                   
00137     timer = 0;
00138 
00139     \textcolor{comment}{// Kolla så att status är rätt }
00140     \textcolor{comment}{// (att de som vi ville skulle hända faktiskt hände)}
00141     \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a86ef56020aa435f9af57015ee220c3e4}{I2Cstatus\_MT\_SLA\_ACK})       
00142     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00143 
00144     \textcolor{comment}{// Ladda in adressen för IMU-registret vi ska läsa ifrån}
00145     TWDR = reg\_addr;                                
00146     TWCR = (1<<TWINT) | (1<<TWEN);      \textcolor{comment}{// Skicka}
00147 
00148     \textcolor{comment}{// Vänta på att det har skickats}
00149     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00150     \{
00151         \_delay\_ms(1);
00152         ++timer;
00153         \textcolor{keywordflow}{if} (timer >= 20)
00154         \{
00155             \textcolor{keywordflow}{return} -1;
00156         \}
00157     \}                   
00158     timer = 0;
00159 
00160     \textcolor{comment}{// Kolla så att status är rätt}
00161     \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}{I2Cstatus\_MT\_DATA\_ACK})     
00162     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00163 
00164     \hyperlink{_i2_c_8c_a263c74ce484e3680c05a9118707fadb7}{I2C\_start}();
00165 
00166     \textcolor{comment}{// Ladda in IMU:ns adress + indikera att läsning ska ske}
00167     TWDR = \hyperlink{_i2_c_8h_ae4af1f304be9d3202a445e7d6c235eaa}{SLA\_R};                                  
00168     TWCR = (1<<TWINT) | (1<<TWEN);      \textcolor{comment}{// Skicka}
00169 
00170     \textcolor{comment}{// Vänta på att det har skickats}
00171     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00172     \{
00173         \_delay\_ms(1);
00174         ++timer;
00175         \textcolor{keywordflow}{if} (timer >= 20)
00176         \{
00177             \textcolor{keywordflow}{return} -1;
00178         \}
00179     \}                   
00180     timer = 0;
00181 
00182     \textcolor{comment}{// Kolla så att status är rätt}
00183     \textcolor{comment}{// (att de som vi ville skulle hända faktiskt hände)}
00184     \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_af046bfee1b2f1837e8a043ead63f8152}{I2Cstatus\_MR\_SLA\_ACK})       
00185     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00186 
00187     \textcolor{keywordflow}{for} (uint8\_t for\_counter = 0; for\_counter < length; for\_counter++)
00188     \{
00189         \textcolor{keywordflow}{if}(for\_counter == length -1)
00190         \{
00191             \textcolor{comment}{// Ta emot data och skicka NACK}
00192             \textcolor{comment}{// (NACK = mottagningen klar och vi ska ej ta emot mer)}
00193             TWCR = (1<<TWINT) | (1<<TWEN);                  
00194 
00195             \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00196             \{
00197                 \_delay\_ms(1);
00198                 ++timer;
00199                 \textcolor{keywordflow}{if} (timer >= 20)
00200                 \{
00201                     \textcolor{keywordflow}{return} -1;
00202                 \}
00203             \}                   \textcolor{comment}{// Vänta på att det har skickats}
00204             timer = 0;
00205 
00206             data[for\_counter] = (TWDR);     \textcolor{comment}{// Spara undan den mottagna datan}
00207 
00208             \textcolor{comment}{// Kolla så att status är rätt}
00209             \textcolor{comment}{// (att de som vi ville skulle hända faktiskt hände)}
00210             \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a3678a376b6b796511e60d0eda8a89dbe}{I2Cstatus\_MR\_DATA\_NACK})       
00211             \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00212         \}
00213         \textcolor{keywordflow}{else}
00214         \{   
00215             \textcolor{comment}{// Ta emot data och skicka ACK}
00216             \textcolor{comment}{// (ACK = mottagningen klar och vi ska fortsätta ta emot data)}
00217             TWCR = (1<<TWINT) | (1<<TWEN) | (1<<TWEA);      
00218 
00219             \textcolor{comment}{// Vänta på att det har skickats}
00220             \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00221             \{
00222                 \_delay\_ms(1);
00223                 ++timer;
00224                 \textcolor{keywordflow}{if} (timer >= 20)
00225                 \{
00226                     \textcolor{keywordflow}{return} -1;
00227                 \}
00228             \}                   
00229             timer = 0;
00230 
00231             data[for\_counter] = (TWDR);     \textcolor{comment}{// Spara undan den mottagna datan}
00232 
00233             \textcolor{comment}{// Kolla så att status är rätt}
00234             \textcolor{comment}{// (att de som vi ville skulle hända faktiskt hände)}
00235             \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_aae56c6775054400d706c68b4701a1659}{I2Cstatus\_MR\_DATA\_ACK})     
00236             \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00237         \}
00238     \}
00239 
00240     \hyperlink{_i2_c_8c_af8dcc1bcb3e1c6c0fcdca4cf599a239b}{I2C\_stop}();     \textcolor{comment}{// Avsluta överföring}
00241     \textcolor{keywordflow}{return} 0;
00242 \}
\end{DoxyCode}
\index{I2\+C.\+h@{I2\+C.\+h}!I2\+C\+\_\+start@{I2\+C\+\_\+start}}
\index{I2\+C\+\_\+start@{I2\+C\+\_\+start}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+C\+\_\+start()}{I2C_start()}}]{\setlength{\rightskip}{0pt plus 5cm}void I2\+C\+\_\+start (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{_i2_c_8h_a263c74ce484e3680c05a9118707fadb7}{}\label{_i2_c_8h_a263c74ce484e3680c05a9118707fadb7}


Opens up the I2\+C-\/bus. 

Opens the bus for communication. All transmissions must be started with this command. Leaves the data line high. 

Definition at line \hyperlink{_i2_c_8c_source_l00015}{15} of file \hyperlink{_i2_c_8c_source}{I2\+C.\+c}.


\begin{DoxyCode}
00016 \{
00017     int8\_t timer = 0;
00018 
00019     TWCR = 0;
00020     TWCR = (1<<TWINT) | (1<<TWSTA) | (1<<TWEN); \textcolor{comment}{// Start}
00021 
00022     \textcolor{comment}{// Vänta på att det har skickats}
00023     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00024     \{
00025         \_delay\_ms(1);
00026         ++timer;
00027         \textcolor{keywordflow}{if} (timer >= 20)
00028         \{
00029             \textcolor{keywordflow}{return} -1;
00030         \}
00031     \}                   
00032     timer = 0;
00033 
00034     \textcolor{keywordflow}{if} ((TWSR & 0xF8) != \hyperlink{_i2_c_8h_ae106ed126eff0ffa33378daacfbbcdb7}{I2Cstatus\_START})    \textcolor{comment}{// Kolla så status = Start}
00035     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00036 \}
\end{DoxyCode}
\index{I2\+C.\+h@{I2\+C.\+h}!I2\+C\+\_\+stop@{I2\+C\+\_\+stop}}
\index{I2\+C\+\_\+stop@{I2\+C\+\_\+stop}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{I2\+C\+\_\+stop()}{I2C_stop()}}]{\setlength{\rightskip}{0pt plus 5cm}void I2\+C\+\_\+stop (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{_i2_c_8h_af8dcc1bcb3e1c6c0fcdca4cf599a239b}{}\label{_i2_c_8h_af8dcc1bcb3e1c6c0fcdca4cf599a239b}


Shuts down the I2\+C-\/bus. 

Sends the stop command for the bus. Leaves the data line high. 

Definition at line \hyperlink{_i2_c_8c_source_l00038}{38} of file \hyperlink{_i2_c_8c_source}{I2\+C.\+c}.


\begin{DoxyCode}
00039 \{
00040     TWCR = (1<<TWINT) | (1<<TWEN) | (1<<TWSTO);     \textcolor{comment}{// STOP}
00041 \}
\end{DoxyCode}
\index{I2\+C.\+h@{I2\+C.\+h}!i2c\+\_\+write@{i2c\+\_\+write}}
\index{i2c\+\_\+write@{i2c\+\_\+write}!I2\+C.\+h@{I2\+C.\+h}}
\subsubsection[{\texorpdfstring{i2c\+\_\+write(unsigned char slave\+\_\+addr, unsigned char reg\+\_\+addr, unsigned char length, unsigned char const $\ast$data)}{i2c_write(unsigned char slave_addr, unsigned char reg_addr, unsigned char length, unsigned char const *data)}}]{\setlength{\rightskip}{0pt plus 5cm}int i2c\+\_\+write (
\begin{DoxyParamCaption}
\item[{unsigned char}]{slave\+\_\+addr, }
\item[{unsigned char}]{reg\+\_\+addr, }
\item[{unsigned char}]{length, }
\item[{unsigned char const $\ast$}]{data}
\end{DoxyParamCaption}
)}\hypertarget{_i2_c_8h_ac0f145afe8d662af199043939f4398d6}{}\label{_i2_c_8h_ac0f145afe8d662af199043939f4398d6}


Writes data to a register at slave. 

Sends some data using the I2\+C-\/bus to a register at the slave address. \begin{DoxySeeAlso}{See also}
I2\+C-\/start 
\end{DoxySeeAlso}

\begin{DoxyParams}{Parameters}
{\em slave\+\_\+addr} & The address of the slave \\
\hline
{\em reg\+\_\+addr} & The register address of the register to be written to at the slave \\
\hline
{\em length} & The length of the transmission \\
\hline
{\em data} & The data to be sent \\
\hline
\end{DoxyParams}


Definition at line \hyperlink{_i2_c_8c_source_l00043}{43} of file \hyperlink{_i2_c_8c_source}{I2\+C.\+c}.


\begin{DoxyCode}
00045 \{
00046     \hyperlink{_i2_c_8c_a263c74ce484e3680c05a9118707fadb7}{I2C\_start}();
00047     int8\_t timer = 0;
00048 
00049     \textcolor{comment}{// Ladda in IMU:ns adress + indikera att skrivning ska ske}
00050     TWDR = \hyperlink{_i2_c_8h_a3df22e1e7b66be8b74b33ce077824292}{SLA\_W};  
00051     TWCR = (1<<TWINT) | (1<<TWEN);          \textcolor{comment}{// Skicka}
00052 
00053     \textcolor{comment}{// Vänta på att det har skickats}
00054     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00055     \{
00056         \_delay\_ms(1);
00057         ++timer;
00058         \textcolor{keywordflow}{if} (timer >= 20)
00059         \{
00060             \textcolor{keywordflow}{return} -1;
00061         \}
00062     \}                   
00063     timer = 0;
00064 
00065     \textcolor{comment}{// Kolla så att status är rätt }
00066     \textcolor{comment}{// (att de som vi ville skulle hända faktiskt hände)}
00067     \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a86ef56020aa435f9af57015ee220c3e4}{I2Cstatus\_MT\_SLA\_ACK})       
00068     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00069 
00070     \textcolor{comment}{// Ladda in adressen för IMU-registret vi ska skriva till}
00071     TWDR = reg\_addr;
00072     TWCR = (1<<TWINT) | (1<<TWEN);                  \textcolor{comment}{// Skicka}
00073 
00074     \textcolor{comment}{// Vänta på att det har skickats}
00075     \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00076     \{
00077         \_delay\_ms(1);
00078         ++timer;
00079         \textcolor{keywordflow}{if} (timer >= 20)
00080         \{
00081             \textcolor{keywordflow}{return} -1;
00082         \}
00083     \}                   
00084     timer = 0;
00085 
00086     \textcolor{comment}{// Kolla så att status är rätt}
00087     \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}{I2Cstatus\_MT\_DATA\_ACK})     
00088     \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00089 
00090     \textcolor{keywordflow}{for} (uint8\_t for\_counter = 0; for\_counter < length; for\_counter++)
00091     \{
00092         TWDR = data[for\_counter];           \textcolor{comment}{// Lägg in den byte som ska skickas}
00093         TWCR = (1<<TWINT) | (1<<TWEN);      \textcolor{comment}{// Skicka byte:n}
00094 
00095         \textcolor{comment}{// Vänta på att det har skickats}
00096         \textcolor{keywordflow}{while} (!(TWCR & (1<<TWINT)))
00097         \{
00098             \_delay\_ms(1);
00099             ++timer;
00100             \textcolor{keywordflow}{if} (timer >= 20)
00101             \{
00102                 \textcolor{keywordflow}{return} -1;
00103             \}
00104         \}                   
00105         timer = 0;
00106 
00107         \textcolor{comment}{// Kolla så att status är rätt}
00108         \textcolor{keywordflow}{if} ((TWSR & 0xF8) !=\hyperlink{_i2_c_8h_a083e480a49a539cd4740d0e1a15216f3}{I2Cstatus\_MT\_DATA\_ACK}) 
00109         \hyperlink{_i2_c_8c_ad1a5ba420409525ff5ab1be86ac5e526}{error}();
00110     \}
00111 
00112     \hyperlink{_i2_c_8c_af8dcc1bcb3e1c6c0fcdca4cf599a239b}{I2C\_stop}();         \textcolor{comment}{// Avsluta överföring}
00113     \textcolor{keywordflow}{return} 0;
00114 \}
\end{DoxyCode}
