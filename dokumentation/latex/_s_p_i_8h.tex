\hypertarget{_s_p_i_8h}{}\section{styr/styr/\+S\+PI.h File Reference}
\label{_s_p_i_8h}\index{styr/styr/\+S\+P\+I.\+h@{styr/styr/\+S\+P\+I.\+h}}


S\+PI bus interface.  


{\ttfamily \#include $<$avr/io.\+h$>$}\\*
{\ttfamily \#include $<$avr/interrupt.\+h$>$}\\*
{\ttfamily \#include $<$util/delay.\+h$>$}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{_s_p_i_8h_a43bafb28b29491ec7f871319b5a3b2f8}{F\+\_\+\+C\+PU}~16000000\+UL
\item 
\#define \hyperlink{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}{S\+S\+\_\+sen}~3
\item 
\#define \hyperlink{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}{S\+S\+\_\+kom}~4
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{_s_p_i_8h_a49ddfef1b082be9cebd28e4bbebf247d}{S\+P\+I\+\_\+init\+\_\+master} ()
\begin{DoxyCompactList}\small\item\em Initiation. \end{DoxyCompactList}\item 
void \hyperlink{_s_p_i_8h_aef55913736b574735fdfca21de557988}{S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master} ()
\begin{DoxyCompactList}\small\item\em Master transmit. \end{DoxyCompactList}\item 
void \hyperlink{_s_p_i_8h_a21ae89e79b07cfb95e2674541cf5ee27}{Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom} (uint8\+\_\+t \hyperlink{_s_p_i_8c_a877332cdcfad9d61a433fda50f5fb1b5}{to\+Sen}, uint8\+\_\+t \hyperlink{_s_p_i_8c_ae9f07651aa8c38a27c260082879ab9b2}{to\+Kom})
\begin{DoxyCompactList}\small\item\em Change slave select. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
volatile unsigned char \hyperlink{_s_p_i_8h_a2963725e5681e7e146da28127b3e09d3}{from\+Sen} \mbox{[}16\mbox{]}
\item 
volatile unsigned char \hyperlink{_s_p_i_8h_a4c1a44ecc2e0f0cf45cf9b6c0bc3e645}{from\+Kom} \mbox{[}16\mbox{]}
\item 
volatile unsigned char \hyperlink{_s_p_i_8h_ab15ab508531e452eb0768f69f7c588da}{last\+Valid\+Packet} \mbox{[}16\mbox{]}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
S\+PI bus interface. 

S\+PI Driver.

\begin{DoxyAuthor}{Author}
Joakim 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
25 apr 2016 Defines functions to communicate over S\+PI with the other modules.
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
kevkj515 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
15/4/2016 Defines communication through the S\+PI bus given a triggered interrupt. 
\end{DoxyDate}


Definition in file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.



\subsection{Macro Definition Documentation}
\index{S\+P\+I.\+h@{S\+P\+I.\+h}!F\+\_\+\+C\+PU@{F\+\_\+\+C\+PU}}
\index{F\+\_\+\+C\+PU@{F\+\_\+\+C\+PU}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{F\+\_\+\+C\+PU}{F_CPU}}]{\setlength{\rightskip}{0pt plus 5cm}\#define F\+\_\+\+C\+PU~16000000\+UL}\hypertarget{_s_p_i_8h_a43bafb28b29491ec7f871319b5a3b2f8}{}\label{_s_p_i_8h_a43bafb28b29491ec7f871319b5a3b2f8}


Definition at line \hyperlink{_s_p_i_8h_source_l00014}{14} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.

\index{S\+P\+I.\+h@{S\+P\+I.\+h}!S\+S\+\_\+kom@{S\+S\+\_\+kom}}
\index{S\+S\+\_\+kom@{S\+S\+\_\+kom}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{S\+S\+\_\+kom}{SS_kom}}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+S\+\_\+kom~4}\hypertarget{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}{}\label{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}


Definition at line \hyperlink{_s_p_i_8h_source_l00022}{22} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.

\index{S\+P\+I.\+h@{S\+P\+I.\+h}!S\+S\+\_\+sen@{S\+S\+\_\+sen}}
\index{S\+S\+\_\+sen@{S\+S\+\_\+sen}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{S\+S\+\_\+sen}{SS_sen}}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+S\+\_\+sen~3}\hypertarget{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}{}\label{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}


Definition at line \hyperlink{_s_p_i_8h_source_l00021}{21} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.



\subsection{Function Documentation}
\index{S\+P\+I.\+h@{S\+P\+I.\+h}!Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom@{Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom}}
\index{Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom@{Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom(uint8\+\_\+t to\+Sen, uint8\+\_\+t to\+Kom)}{Set_SS_sen_kom(uint8_t toSen, uint8_t toKom)}}]{\setlength{\rightskip}{0pt plus 5cm}void Set\+\_\+\+S\+S\+\_\+sen\+\_\+kom (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t}]{to\+Sen, }
\item[{uint8\+\_\+t}]{to\+Kom}
\end{DoxyParamCaption}
)}\hypertarget{_s_p_i_8h_a21ae89e79b07cfb95e2674541cf5ee27}{}\label{_s_p_i_8h_a21ae89e79b07cfb95e2674541cf5ee27}


Change slave select. 

Sets the slave select ports to their respective value given \textquotesingle{}bools\textquotesingle{} of what they should be 

Definition at line \hyperlink{_s_p_i_8c_source_l00112}{112} of file \hyperlink{_s_p_i_8c_source}{S\+P\+I.\+c}.


\begin{DoxyCode}
00113 \{
00114     \textcolor{keywordflow}{if}(\hyperlink{_s_p_i_8c_ae9f07651aa8c38a27c260082879ab9b2}{toKom} == 1)\{
00115         PORTB &= ~(1 << \hyperlink{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}{SS\_sen});
00116         PORTB |= (1 << \hyperlink{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}{SS\_kom});
00117     \}
00118     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{_s_p_i_8c_a877332cdcfad9d61a433fda50f5fb1b5}{toSen} == 1)\{
00119         PORTB |= (1 << \hyperlink{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}{SS\_sen});
00120         PORTB &= ~(1 << \hyperlink{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}{SS\_kom});
00121     \}
00122     \textcolor{keywordflow}{else}\{
00123         PORTB |= (1 << \hyperlink{_s_p_i_8h_a58ac62acddf451691b748c71454e0137}{SS\_sen});
00124         PORTB |= (1 << \hyperlink{_s_p_i_8h_acbbd0eb471ac972ee5d3bb2563a6c72e}{SS\_kom});
00125     \}
00126 \}
\end{DoxyCode}
\index{S\+P\+I.\+h@{S\+P\+I.\+h}!S\+P\+I\+\_\+init\+\_\+master@{S\+P\+I\+\_\+init\+\_\+master}}
\index{S\+P\+I\+\_\+init\+\_\+master@{S\+P\+I\+\_\+init\+\_\+master}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{S\+P\+I\+\_\+init\+\_\+master()}{SPI_init_master()}}]{\setlength{\rightskip}{0pt plus 5cm}void S\+P\+I\+\_\+init\+\_\+master (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{_s_p_i_8h_a49ddfef1b082be9cebd28e4bbebf247d}{}\label{_s_p_i_8h_a49ddfef1b082be9cebd28e4bbebf247d}


Initiation. 

Initiates the outputs and S\+PI configuration as a master on the bus 

Definition at line \hyperlink{_s_p_i_8c_source_l00127}{127} of file \hyperlink{_s_p_i_8c_source}{S\+P\+I.\+c}.


\begin{DoxyCode}
00128 \{
00129     \textcolor{comment}{/*Nollställer fromKom & fromSen (tar bort ev skräp på minnesplatserna) }
00130 \textcolor{comment}{      så inget konstigt händer innan första avbrottet kommit.*/}
00131     memset(\hyperlink{_s_p_i_8h_a4c1a44ecc2e0f0cf45cf9b6c0bc3e645}{fromKom}, 0, \textcolor{keyword}{sizeof}(\hyperlink{_s_p_i_8h_a4c1a44ecc2e0f0cf45cf9b6c0bc3e645}{fromKom})); 
00132     memset(\hyperlink{_s_p_i_8h_a2963725e5681e7e146da28127b3e09d3}{fromSen}, 0, \textcolor{keyword}{sizeof}(\hyperlink{_s_p_i_8h_a2963725e5681e7e146da28127b3e09d3}{fromSen}));
00133     memset(\hyperlink{_s_p_i_8h_ab15ab508531e452eb0768f69f7c588da}{lastValidPacket}, 0, \textcolor{keyword}{sizeof}(\hyperlink{_s_p_i_8h_ab15ab508531e452eb0768f69f7c588da}{lastValidPacket}));
00134     
00135     \textcolor{comment}{//MOSI, SCK , SS0 och SS1 är utgångar}
00136     DDRB |= 0b10111000; 
00137     \hyperlink{_s_p_i_8c_a153ce55af60458b262b041d44bfe9350}{overflow} = 0;
00138     \textcolor{comment}{//SPI Enable}
00139     \textcolor{comment}{//SPI Master}
00140     \textcolor{comment}{//SPI clock f/16}
00141     \textcolor{comment}{//SPI interrupt enable}
00142     SPCR = (1<<SPE)|(1<<MSTR)|(1<<SPR0)|(1<<SPIE);
00143     
00144     \textcolor{comment}{// Aktivera avbrott för timer 0}
00145     TIMSK0 = (1<<TOIE0);
00146     \textcolor{comment}{// Sätt timer 0-räknarens initialvärde till 0}
00147     TCNT0=0x00;
00148     \textcolor{comment}{// Starta timer 0 med /1024 "prescaler"}
00149     TCCR0B = (1<<CS02) | (1<<CS00);
00150     
00151     \hyperlink{_s_p_i_8c_a65d46084e88aa717b668dffbbda1bf3b}{SPIcounter} = 0;
00152     uint8\_t \hyperlink{_s_p_i_8c_a877332cdcfad9d61a433fda50f5fb1b5}{toSen} = 0;
00153     uint8\_t \hyperlink{_s_p_i_8c_ae9f07651aa8c38a27c260082879ab9b2}{toKom} = 0;
00154     
00155     \hyperlink{_s_p_i_8c_a21ae89e79b07cfb95e2674541cf5ee27}{Set\_SS\_sen\_kom}(toSen, toKom);
00156 \}\end{DoxyCode}
\index{S\+P\+I.\+h@{S\+P\+I.\+h}!S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master@{S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master}}
\index{S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master@{S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master()}{SPI_sen_transmit_master()}}]{\setlength{\rightskip}{0pt plus 5cm}void S\+P\+I\+\_\+sen\+\_\+transmit\+\_\+master (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{_s_p_i_8h_aef55913736b574735fdfca21de557988}{}\label{_s_p_i_8h_aef55913736b574735fdfca21de557988}


Master transmit. 

Transmits the first byte to Sensor Module starting the chain of 16 

Definition at line \hyperlink{_s_p_i_8c_source_l00026}{26} of file \hyperlink{_s_p_i_8c_source}{S\+P\+I.\+c}.


\begin{DoxyCode}
00027 \{
00028     \hyperlink{_s_p_i_8c_a65d46084e88aa717b668dffbbda1bf3b}{SPIcounter} = 0;
00029     \textcolor{comment}{//Sätter SS för styr->sen}
00030     \hyperlink{_s_p_i_8c_a877332cdcfad9d61a433fda50f5fb1b5}{toSen} = 1;
00031     \hyperlink{_s_p_i_8c_ae9f07651aa8c38a27c260082879ab9b2}{toKom} = 0;
00032     \hyperlink{_s_p_i_8c_a21ae89e79b07cfb95e2674541cf5ee27}{Set\_SS\_sen\_kom}(\hyperlink{_s_p_i_8c_a877332cdcfad9d61a433fda50f5fb1b5}{toSen}, \hyperlink{_s_p_i_8c_ae9f07651aa8c38a27c260082879ab9b2}{toKom});
00033     \textcolor{comment}{// skickar noll till Sen}
00034     SPDR = 0;
00035 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\index{S\+P\+I.\+h@{S\+P\+I.\+h}!from\+Kom@{from\+Kom}}
\index{from\+Kom@{from\+Kom}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{from\+Kom}{fromKom}}]{\setlength{\rightskip}{0pt plus 5cm}volatile unsigned char from\+Kom\mbox{[}16\mbox{]}}\hypertarget{_s_p_i_8h_a4c1a44ecc2e0f0cf45cf9b6c0bc3e645}{}\label{_s_p_i_8h_a4c1a44ecc2e0f0cf45cf9b6c0bc3e645}


Definition at line \hyperlink{_s_p_i_8h_source_l00025}{25} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.

\index{S\+P\+I.\+h@{S\+P\+I.\+h}!from\+Sen@{from\+Sen}}
\index{from\+Sen@{from\+Sen}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{from\+Sen}{fromSen}}]{\setlength{\rightskip}{0pt plus 5cm}volatile unsigned char from\+Sen\mbox{[}16\mbox{]}}\hypertarget{_s_p_i_8h_a2963725e5681e7e146da28127b3e09d3}{}\label{_s_p_i_8h_a2963725e5681e7e146da28127b3e09d3}


Definition at line \hyperlink{_s_p_i_8h_source_l00024}{24} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.

\index{S\+P\+I.\+h@{S\+P\+I.\+h}!last\+Valid\+Packet@{last\+Valid\+Packet}}
\index{last\+Valid\+Packet@{last\+Valid\+Packet}!S\+P\+I.\+h@{S\+P\+I.\+h}}
\subsubsection[{\texorpdfstring{last\+Valid\+Packet}{lastValidPacket}}]{\setlength{\rightskip}{0pt plus 5cm}volatile unsigned char last\+Valid\+Packet\mbox{[}16\mbox{]}}\hypertarget{_s_p_i_8h_ab15ab508531e452eb0768f69f7c588da}{}\label{_s_p_i_8h_ab15ab508531e452eb0768f69f7c588da}


Definition at line \hyperlink{_s_p_i_8h_source_l00027}{27} of file \hyperlink{_s_p_i_8h_source}{S\+P\+I.\+h}.

